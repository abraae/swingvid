<!DOCTYPE html>
<html>
<head>
    <title>RecordRTC with timeSlice</title>
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
</head>
<body>
    <video id="video" controls autoplay></video>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording" disabled>Stop Recording</button>
    <a id="downloadLink" style="display:none;">Download Video</a>

    <script>
        let video = document.getElementById('video');
        let startRecordingButton = document.getElementById('startRecording');
        let stopRecordingButton = document.getElementById('stopRecording');
        let downloadLink = document.getElementById('downloadLink');

        let recorder;
        let stream;
        let recordedBlobs = [];

        startRecordingButton.onclick = async () => {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            video.srcObject = stream;

            recorder = new RecordRTC(stream, {
                type: 'video',
                timeSlice: 1000, // 1 second
                ondataavailable: (blob) => {
                    recordedBlobs.push(blob);
                }
            });

            recorder.startRecording();
            startRecordingButton.disabled = true;
            stopRecordingButton.disabled = false;
        };

        stopRecordingButton.onclick = () => {
            recorder.stopRecording(() => {
                // Combine only the last four recorded blobs
                let lastFourBlobs = recordedBlobs.slice(-4);

                // Use MediaSource API for seamless playback
                let mediaSource = new MediaSource();
                video.src = URL.createObjectURL(mediaSource);

                mediaSource.addEventListener('sourceopen', () => {
                    let sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8, vorbis"');

                    let appendNextBlob = (index) => {
                        if (index < lastFourBlobs.length) {
                            let reader = new FileReader();
                            reader.onload = () => {
                                sourceBuffer.appendBuffer(new Uint8Array(reader.result));
                                sourceBuffer.addEventListener('updateend', () => appendNextBlob(index + 1), { once: true });
                            };
                            reader.readAsArrayBuffer(lastFourBlobs[index]);
                        } else {
                            mediaSource.endOfStream();
                        }
                    };

                    appendNextBlob(0);
                });

                // Create a downloadable link for the combined Blobs
                let combinedBlobs = new Blob(lastFourBlobs, { type: 'video/webm' });
                let url = URL.createObjectURL(combinedBlobs);

                downloadLink.href = url;
                downloadLink.download = 'recorded-video.webm';
                downloadLink.style.display = 'block';

                stream.getTracks().forEach(track => track.stop());
                startRecordingButton.disabled = false;
                stopRecordingButton.disabled = true;
            });
        };
    </script>
</body>
</html>
